&НаКлиенте
Процедура ВыбратьЗавКафед(Команда)
	ОбработкаВыбора = Новый ОписаниеОповещения("ВывестиСписокПолучателей", ЭтаФорма, "ЗавКаф");
	Форма = ОткрытьФорму("Обработка.РассылкаПочты.Форма.ВыборПолучателей", Новый Структура("ТипОтбора", "ЗавКаф"), ЭтаФорма,,,, ОбработкаВыбора);
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьУчСек(Команда)
	ОбработкаВыбора = Новый ОписаниеОповещения("ВывестиСписокПолучателей", ЭтаФорма, "УчСек");
	Форма = ОткрытьФорму("Обработка.РассылкаПочты.Форма.ВыборПолучателей", Новый Структура("ТипОтбора", "УчСек"), ЭтаФорма,,,, ОбработкаВыбора);
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьСтудентов(Команда)
	ОбработкаВыбора = Новый ОписаниеОповещения("ВывестиСписокПолучателей", ЭтаФорма, "Студ");
	Форма = ОткрытьФорму("Обработка.РассылкаПочты.Форма.ВыборПолучателей", Новый Структура("ТипОтбора", "Студ"), ЭтаФорма,,,, ОбработкаВыбора);
КонецПроцедуры

&НаКлиенте
Процедура ВыбратьСотрудников(Команда)
	ОбработкаВыбора = Новый ОписаниеОповещения("ВывестиСписокПолучателей", ЭтаФорма, "Сотруд");
	Форма = ОткрытьФорму("Обработка.РассылкаПочты.Форма.ВыборПолучателей", Новый Структура("ТипОтбора", "Сотруд"), ЭтаФорма,,,, ОбработкаВыбора);
КонецПроцедуры

&НаСервере
Процедура ВывестиСписокПолучателей(Значение, ДопПараметры) Экспорт
    Если Значение = Неопределено Тогда
        Возврат;
	КонецЕсли;
	Получатели = Значение;
КонецПроцедуры

&НаКлиенте
Процедура ФайлыПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	Если НоваяСтрока = Истина И Копирование = Ложь Тогда
		ДиалогФыбораФайла = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
		ДиалогФыбораФайла.Заголовок = "Выберите файл";
		ДиалогФыбораФайла.МножественныйВыбор = Истина;
		ДиалогФыбораФайла.ПредварительныйПросмотр = Истина;
		Если ДиалогФыбораФайла.Выбрать() Тогда
			Для Инд = 0 По ДиалогФыбораФайла.ВыбранныеФайлы.ВГраница() Цикл
				ПараметрыФайла = Новый Файл(ДиалогФыбораФайла.ВыбранныеФайлы[Инд]);
				Если Инд <> 0 Тогда
					СТЗФайлы = Файлы.Добавить();
					СТЗФайлы.ИмяФайла = ПараметрыФайла.Имя;
					СТЗФайлы.ПолныйПуть = ПараметрыФайла.ПолноеИмя;
				Иначе
					Элемент.ТекущиеДанные.ИмяФайла = ПараметрыФайла.Имя;
					Элемент.ТекущиеДанные.ПолныйПуть = ПараметрыФайла.ПолноеИмя;
				КонецЕсли;
			КонецЦикла;
		Иначе
			Файлы.Удалить(Файлы.Количество() - 1);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьСообщение(Команда)
	// Проверка на заполненность списка адресатов
	Получатели.Область("R1C1").Текст = "Почта";
	Если Получатели.ВысотаТаблицы < 2 Тогда
		Сообщить("Список получателей не заполнен");
		Возврат;
	КонецЕсли;
	Если ОтправитьСообщениеНаСервере() Тогда
		Сообщить("Готово!");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ОтправитьСообщениеНаСервере()
	Перем HTML, Картинки;
	// Получаем всех адресатов из табличного документа
	ОбластьЯчеек = Получатели.Область(1, 1, Получатели.ВысотаТаблицы, 1);
	ИсточникДанных = Новый ОписаниеИсточникаДанных(ОбластьЯчеек);
	ПостроительОтчета = Новый ПостроительОтчета; 
	ПостроительОтчета.ИсточникДанных = ИсточникДанных;
	Отб = ПостроительОтчета.Отбор.Добавить("Почта");
	Отб.Использование = Истина;
	Отб.ВидСравнения = ВидСравнения.НеРавно;
	Отб.Значение = "";
	ПостроительОтчета.Выполнить();
	ТЗ = ПостроительОтчета.Результат.Выгрузить();
	Если ТЗ.Количество() = 0 Тогда
		Сообщить("Список получателей не заполнен");
		Возврат Ложь;
	КонецЕсли;
	
	// Подготавливаем параметры для процедуры отправки сообщения
	Адреса = Новый Массив;
	Для Каждого СТЗ Из ТЗ Цикл
		Адреса.Добавить(СТЗ.Почта);
	КонецЦикла;
	ТекстСообщения.ПолучитьHTML(HTML, Картинки);
	
	Вложения = Новый Массив;
	Для Каждого Файл Из Файлы Цикл
		Вложения.Добавить(Новый Структура("Имя, ПолныйПуть", Файл.ИмяФайла, Файл.ПолныйПуть));
	КонецЦикла;
	
	// Попытка отправить всё это безобразие
	Попытка
		РаботаСПочтой.ОтправкаФорматированногоСообщения(ТемаСообщения, HTML, Картинки, Адреса, ПочтаОтправителя, ИмяОтправителя, Вложения);
		Возврат Истина;
	Исключение
		Сообщить(ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
КонецФункции

&НаКлиенте
Процедура Очистить(Команда)
	Получатели = Новый ТабличныйДокумент;
	Получатели.Область("R1C1").Текст = "Почта";
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПочтаОтправителя = "1cmailing@bseu.by";
	ИмяОтправителя = "1C Admin";
	Получатели.Область("R1C1").Текст = "Почта";
КонецПроцедуры
